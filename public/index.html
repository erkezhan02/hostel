<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –û—Ç–µ–ª–µ–π</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<h2>–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–µ–ª—å</h2>
<input type="text" id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ç–µ–ª—è">
<input type="text" id="location" placeholder="–ì–æ—Ä–æ–¥">
<input type="number" id="rating" placeholder="–†–µ–π—Ç–∏–Ω–≥ (1-5)">
<input type="text" id="amenities" placeholder="–£–¥–æ–±—Å—Ç–≤–∞ (Wi-Fi, –ë–∞—Å—Å–µ–π–Ω)">
<button onclick="addHotel()">–î–æ–±–∞–≤–∏—Ç—å</button>

<h2>–û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–µ–ª—å</h2>
<input type="text" id="update-id" placeholder="ID –æ—Ç–µ–ª—è" readonly>
<input type="text" id="update-name" placeholder="–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
<input type="text" id="update-location" placeholder="–ù–æ–≤—ã–π –≥–æ—Ä–æ–¥">
<input type="number" id="update-rating" placeholder="–ù–æ–≤—ã–π —Ä–µ–π—Ç–∏–Ω–≥ (1-5)">
<input type="text" id="update-amenities" placeholder="–ù–æ–≤—ã–µ —É–¥–æ–±—Å—Ç–≤–∞">
<button onclick="updateHotel()">–û–±–Ω–æ–≤–∏—Ç—å</button>

<h2>–°–ø–∏—Å–æ–∫ –æ—Ç–µ–ª–µ–π</h2>
<button onclick="getHotels()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–µ–ª–∏</button>
<div class="hotels"></div>

<h2>–ü–æ–∏—Å–∫ –æ—Ç–µ–ª–µ–π –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É</h2>
<div>
    <input type="number" id="min-rating" placeholder="–ú–∏–Ω. —Ä–µ–π—Ç–∏–Ω–≥ (1-5)" min="1" max="5">
    <input type="number" id="max-rating" placeholder="–ú–∞–∫—Å. —Ä–µ–π—Ç–∏–Ω–≥ (1-5)" min="1" max="5">
    <button onclick="searchHotelsByRating()">–ù–∞–π—Ç–∏ –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É</button>
</div>
<div id="rating-results" class="hotels"></div>

<h2>–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤</h2>
<button onclick="generateTestData()">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
<button onclick="checkIndexes()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã</button>
<button onclick="deleteTestData()">üóë –£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
<div id="index-results"></div>


<script>
    const API_URL = "http://localhost:5000/hotels";
    const SEARCH_URL = "http://localhost:5000/hotels/search";


    window.checkIndexes = function () {
        const resultsContainer = document.getElementById("index-results");
        resultsContainer.innerHTML = "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤...";

        fetch(`${API_URL}/check-indexes`)
            .then(res => {
                if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞: ${res.status}`);
                return res.json();
            })
            .then(data => {
                console.log("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:", data);
                let html = "<h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω–¥–µ–∫—Å–æ–≤</h3>";
                html += "<table border='1' style='width:100%; text-align:center;'>";
                html += `
            <tr>
              <th>–¢–∏–ø –∏–Ω–¥–µ–∫—Å–∞</th>
              <th>–î–æ–∫-–æ–≤ –±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞</th>
              <th>–í—Ä–µ–º—è –±–µ–∑ –∏–Ω–¥–µ–∫—Å–∞ (–º—Å)</th>
              <th>–î–æ–∫-–æ–≤ —Å –∏–Ω–¥–µ–∫—Å–æ–º</th>
              <th>–í—Ä–µ–º—è —Å –∏–Ω–¥–µ–∫—Å–æ–º (–º—Å)</th>
              <th>–†–∞–∑–Ω–∏—Ü–∞/–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
            </tr>
          `;

                for (const key in data) {
                    let rowHtml = "";
                    const item = data[key];
                    if (item.error) {
                        rowHtml = `<tr>
                <td><b>${key}</b></td>
                <td colspan="5" style="color: red;">–û—à–∏–±–∫–∞: ${item.error}</td>
              </tr>`;
                    } else if (item.withoutIndex && item.withIndex) {
                        const improvement = item.withoutIndex.executionTimeMillis - item.withIndex.executionTimeMillis;
                        rowHtml = `<tr>
                <td><b>${key}</b></td>
                <td>${item.withoutIndex.totalDocsExamined}</td>
                <td>${item.withoutIndex.executionTimeMillis} –º—Å</td>
                <td>${item.withIndex.totalDocsExamined}</td>
                <td>${item.withIndex.executionTimeMillis} –º—Å</td>
                <td style="color: ${improvement > 0 ? 'green' : 'red'};">${improvement} –º—Å</td>
              </tr>`;
                    }
                    html += rowHtml;
                }

                html += "</table>";
                resultsContainer.innerHTML = html;
            })
            .catch(err => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∏–Ω–¥–µ–∫—Å–æ–≤:", err);
                document.getElementById("index-results").innerHTML = `–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∏–Ω–¥–µ–∫—Å–æ–≤: ${err.message}`;
            });
    };


    function generateTestData() {
        fetch(`${API_URL}/generate-test-hotels`, { method: "POST" })
            .then(res => res.json())
            .then(data => alert(data.message))
            .catch(err => alert("–û—à–∏–±–∫–∞: " + err.message));
    }

    function deleteTestData() {
        fetch("http://localhost:5000/hotels/delete-test-hotels", { method: "DELETE" })
            .then(async res => {
                // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ 2xx, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Å —Ç–µ–∫—Å—Ç–æ–º –æ—Ç–≤–µ—Ç–∞
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.error || `–û—à–∏–±–∫–∞: ${res.status}`);
                }
                return res.json();
            })
            .then(data => alert(data.message))
            .catch(err => alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö: " + err.message));
    }


    function getHotels() {
        fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                const hotelsContainer = document.querySelector(".hotels");
                let html = "";
                data.forEach(hotel => {
                    html += `
                    <div class="hotel-card">
                        <h3>${hotel.name}</h3>
                        <p><b>–ì–æ—Ä–æ–¥:</b> ${hotel.location}</p>
                        <p><b>–†–µ–π—Ç–∏–Ω–≥:</b> ${hotel.rating}‚òÖ</p>
                        <p><b>–£–¥–æ–±—Å—Ç–≤–∞:</b> ${hotel.amenities.join(", ")}</p>
                        <button class="edit-btn" onclick="fillUpdateForm('${hotel._id}', '${hotel.name}', '${hotel.location}', '${hotel.rating}', '${hotel.amenities.join(", ")}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="delete-btn" onclick="deleteHotel('${hotel._id}')">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>`;
                });
                hotelsContainer.innerHTML = html;
            })
            .catch(err => {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ—Ç–µ–ª–µ–π:", err);
            });
    }

    function addHotel() {
        const name = document.getElementById("name").value;
        const location = document.getElementById("location").value;
        const rating = document.getElementById("rating").value;
        const amenities = document.getElementById("amenities").value.split(",");

        fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, location, rating, amenities })
        }).then(() => getHotels());
    }

    function updateHotel() {
        const id = document.getElementById("update-id").value;
        const name = document.getElementById("update-name").value;
        const location = document.getElementById("update-location").value;
        const rating = document.getElementById("update-rating").value;
        const amenities = document.getElementById("update-amenities").value.split(",");

        fetch(`${API_URL}/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, location, rating, amenities })
        }).then(() => getHotels());
    }

    function fillUpdateForm(id, name, location, rating, amenities) {
        document.getElementById("update-id").value = id;
        document.getElementById("update-name").value = name;
        document.getElementById("update-location").value = location;
        document.getElementById("update-rating").value = rating;
        document.getElementById("update-amenities").value = amenities;
    }

    function deleteHotel(id) {
        fetch(`${API_URL}/${id}`, { method: "DELETE" })
            .then(() => getHotels());
    }

    function searchHotelsByRating() {
        const minRating = parseFloat(document.getElementById("min-rating").value) || 1;
        const maxRating = parseFloat(document.getElementById("max-rating").value) || 5;
        const resultsContainer = document.getElementById("rating-results");

        resultsContainer.innerHTML = "<p> –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</p>";

        fetch(`${SEARCH_URL}?minRating=${minRating}&maxRating=${maxRating}`)
            .then(res => res.json())
            .then(data => {
                if (!data.length) {
                    resultsContainer.innerHTML = "<p> –û—Ç–µ–ª–µ–π —Å —Ç–∞–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>";
                    return;
                }

                let html = "";

                // –ü–µ—Ä–µ–±–æ—Ä –≥—Ä—É–ø–ø –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º —Ä–µ–π—Ç–∏–Ω–≥–∞ ($bucket)
                data.forEach(group => {
                    html += `
                <div class="rating-group">
                    <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–µ–ª–µ–π: ${group.count}</p>
                    <div class="hotel-list">
                `;

                    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø–µ
                    group.hotels.forEach(hotel => {
                        html += `
                    <div class="hotel-card">
                        <h4>${hotel.name}</h4>
                        <p><b>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</b> ${hotel.location}</p>
                        <p><b>–†–µ–π—Ç–∏–Ω–≥:</b> ${hotel.rating}</p>
                        <p><b>–£–¥–æ–±—Å—Ç–≤–∞:</b> ${hotel.amenities?.length ? hotel.amenities.join(", ") : "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"}</p>
                        <button onclick="fillUpdateForm('${hotel._id}', '${hotel.name}', '${hotel.location}', '${hotel.rating}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button onclick="deleteHotel('${hotel._id}')"> –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                `;
                    });

                    html += `</div></div><hr/>`;
                });

                resultsContainer.innerHTML = html;
            })
            .catch(err => {
                console.error(" –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞:", err);
                resultsContainer.innerHTML = "<p> –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–µ–ª–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.</p>";
            });

    }

</script>
</body>
</html>
